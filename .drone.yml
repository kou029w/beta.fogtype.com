# yaml-language-server: $schema=https://json.schemastore.org/drone.json
name: deploy
kind: pipeline
type: docker
node:
  instance: system
trigger:
  event:
    - push
  branch:
    - main
steps:
  - name: deploy
    image: docker:20.10.23-cli-alpine3.17@sha256:f5434ee24dfd149d2f9d8ef269feb368c1593156d60abe0d7e7e435a226809e0
    commands:
      - mkdir -p /root/.ssh
      - install -v -m 600 /home/ubuntu/.ssh/id_ed25519 /root/.ssh/id_ed25519
      - ssh-keyscan beta.fogtype.com >> /root/.ssh/known_hosts
      - docker context create --docker=host=ssh://ubuntu@beta.fogtype.com beta
      - docker context use beta
      - docker compose --project-name=beta up --build --detach
      - docker compose --project-directory=example up --detach
    volumes:
      - name: ssh_key
        path: /home/ubuntu/.ssh/id_ed25519
volumes:
  - name: ssh_key
    host:
      path: /home/ubuntu/.ssh/id_ed25519
